{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4">Video Editor</h1>
<div class="video-container position-relative">
    {% for frame_index in frame_numbers %}
        <img hidden id="frame-{{ frame_index }}" src="{{ url_for('serve_frame', guid=video_id, index=frame_index) }}" alt="Frame {{ frame_index }}" 
        class="video-frame">
    {% endfor %}
    <div id="click-markers"></div>
</div>
<div class="controls mt-3">
    <button id="prev-frame" class="btn btn-primary">Previous</button>
    <button id="next-frame" class="btn btn-primary">Next</button>
</div>

<div class="labels-container mt-3">
    <h3>Labels</h3>
    <ul id="labels-list" class="list-group">
        <!-- Labels will be dynamically added here -->
    </ul>
    <button id="add-label" class="btn btn-success mt-2">Add Label</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let currentIndex = 1;
        const totalFrames = 150;
        let clicks = [];
        let labelCount = 0;

        function addClick(x, y, frameIndex) {
            clicks.push({x: x, y: y, frame: frameIndex});
            console.log(`Click added at (${x}, ${y}) on frame ${frameIndex}. Total clicks: ${clicks.length}`);
            renderClicks();
        }

        function removeClick(x, y, frameIndex) {
            const tolerance = 10; // 10 pixels tolerance
            let closestClick = null;
            let minDistance = Infinity;

            clicks.forEach((click, index) => {
                if (click.frame === frameIndex) {
                    const distanceX = Math.abs(click.x - x);
                    const distanceY = Math.abs(click.y - y);
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
                    if (distance < minDistance && distance <= tolerance) {
                        minDistance = distance;
                        closestClick = index;
                    }
                }
            });

            if (closestClick !== null) {
                clicks.splice(closestClick, 1);
                console.log(`Closest click removed near (${x}, ${y}) on frame ${frameIndex}. Total clicks: ${clicks.length}`);
                renderClicks();
            } else {
                console.log(`No click found near (${x}, ${y}) on frame ${frameIndex} within tolerance.`);
            }
        }

        function renderClicks() {
            $('#click-markers').empty();
            clicks.forEach((click, index) => {
                if (click.frame === currentIndex) {
                    const marker = $('<span>')
                        .addClass('click-marker')
                        .css({
                            position: 'absolute',
                            left: click.x + 'px',
                            top: click.y + 'px',
                            width: '10px',
                            height: '10px',
                            borderRadius: '50%',
                            backgroundColor: 'red',
                            pointerEvents: 'none'
                        });
                    $('#click-markers').append(marker);
                }
            });
        }

        $('.video-frame').on('click contextmenu', function(event) {
            event.preventDefault();
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const frameIndex = parseInt($(this).attr('id').split('-')[1]);
            
            if (event.type === 'contextmenu') {
                removeClick(x, y, frameIndex);
            } else {
                addClick(x, y, frameIndex);
            }
        });

        function showFrame(index) {
            console.log(`Showing frame ${index}`);
            $('.video-frame').removeAttr('hidden');
            $('.video-frame').not(`#frame-${index}`).attr('hidden', 'hidden');
            $(`#frame-${index}`).show();
            renderClicks();
        }

        showFrame(currentIndex);

        $('#prev-frame').click(function() {
            if (currentIndex > 1) {
                currentIndex--;
                showFrame(currentIndex);
            }
        });

        $('#next-frame').click(function() {
            if (currentIndex < totalFrames) {
                currentIndex++;
                showFrame(currentIndex);
            }
        });

        // Label management
        const labelColors = ['#FFB3BA', '#BAFFC9', '#BAE1FF', '#FFFFBA', '#FFDFBA'];
        let colorIndex = 0;

        function addLabel() {
            labelCount++;
            const labelId = `label-${labelCount}`;
            const backgroundColor = labelColors[colorIndex];
            colorIndex = (colorIndex + 1) % labelColors.length;
            const labelHtml = `
                <li id="${labelId}" class="list-group-item d-flex justify-content-between align-items-center" style="background-color: ${backgroundColor}">
                    <input type="text" class="form-control mr-2" value="Object ${labelCount}">
                    <button class="btn btn-danger btn-sm delete-label">Delete</button>
                </li>
            `;
            $('#labels-list').append(labelHtml);
        }

        $('#add-label').click(addLabel);

        $(document).on('click', '.delete-label', function() {
            $(this).closest('li').remove();
        });

        // Add initial label
        addLabel();
    });
</script>
{% endblock %}
