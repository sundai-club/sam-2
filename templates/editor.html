{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4">Video Editor</h1>
<div class="video-container position-relative">
    {% for frame_index in frame_numbers %}
        <img hidden id="frame-{{ frame_index }}" src="{{ url_for('serve_frame', guid=video_id, index=frame_index) }}" alt="Frame {{ frame_index }}" 
        class="video-frame">
    {% endfor %}
    <div id="click-markers"></div>
</div>
<div class="controls mt-3">
    <button id="prev-frame" class="btn btn-primary">Previous</button>
    <button id="next-frame" class="btn btn-primary">Next</button>
</div>

<div class="object-list mt-4">
    <h2>Objects</h2>
    <ul id="object-list" class="list-group">
        <!-- Remove the hardcoded first object -->
    </ul>
    <button id="add-object" class="btn btn-success mt-2">Add Object</button>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let currentIndex = 1;
        const totalFrames = 150;
        let clicks = [];
        let objectCount = 0;
        const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'orange'];

        function addClick(x, y, frameIndex) {
            clicks.push({x: x, y: y, frame: frameIndex});
            console.log(`Click added at (${x}, ${y}) on frame ${frameIndex}. Total clicks: ${clicks.length}`);
            renderClicks();
        }

        function removeClick(x, y, frameIndex) {
            const tolerance = 10; // 10 pixels tolerance
            let closestClick = null;
            let minDistance = Infinity;

            clicks.forEach((click, index) => {
                if (click.frame === frameIndex) {
                    const distanceX = Math.abs(click.x - x);
                    const distanceY = Math.abs(click.y - y);
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
                    if (distance < minDistance && distance <= tolerance) {
                        minDistance = distance;
                        closestClick = index;
                    }
                }
            });

            if (closestClick !== null) {
                clicks.splice(closestClick, 1);
                console.log(`Closest click removed near (${x}, ${y}) on frame ${frameIndex}. Total clicks: ${clicks.length}`);
                renderClicks();
            } else {
                console.log(`No click found near (${x}, ${y}) on frame ${frameIndex} within tolerance.`);
            }
        }

        function renderClicks() {
            $('#click-markers').empty();
            clicks.forEach((click, index) => {
                if (click.frame === currentIndex) {
                    const marker = $('<span>')
                        .addClass('click-marker')
                        // .addClass(`color-${colors[index % colors.length]}`)
                        .css({
                            left: click.x + 'px',
                            top: click.y + 'px'
                        });
                    $('#click-markers').append(marker);
                }
            });
        }

        $('.video-frame').on('click contextmenu', function(event) {
            event.preventDefault();
            const rect = event.target.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const frameIndex = parseInt($(this).attr('id').split('-')[1]);
            
            if (event.type === 'contextmenu') {
                removeClick(x, y, frameIndex);
            } else {
                addClick(x, y, frameIndex);
            }
        });

        function showFrame(index) {
            console.log(`Showing frame ${index}`);
            $('.video-frame').removeAttr('hidden');
            $('.video-frame').not(`#frame-${index}`).attr('hidden', 'hidden');
            $(`#frame-${index}`).show();
            renderClicks();
        }

        showFrame(currentIndex);

        $('#prev-frame').click(function() {
            if (currentIndex > 1) {
                currentIndex--;
                showFrame(currentIndex);
            }
        });

        $('#next-frame').click(function() {
            if (currentIndex < totalFrames) {
                currentIndex++;
                showFrame(currentIndex);
            }
        });

        // Object list functionality
        $('#add-object').click(function() {
            objectCount++;
            const color = colors[(objectCount - 1) % colors.length];
            const newObject = $('<li>')
                .addClass('list-group-item d-flex justify-content-between align-items-center')
                .addClass(`bg-${color}-light`)
                .html(`
                    <span class="object-name" contenteditable="true" data-color="${color}">Object ${objectCount}</span>
                    <button class="btn btn-danger btn-sm delete-object">Delete</button>
                `);
            $('#object-list').append(newObject);
        });

        // Delete object
        $('#object-list').on('click', '.delete-object', function() {
            $(this).closest('li').remove();
        });

        // Make object name editable
        $('#object-list').on('blur', '.object-name', function() {
            if ($(this).text().trim() === '') {
                $(this).text('Unnamed Object');
            }
        });

        // Add the first object programmatically
        $('#add-object').click();
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .click-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
    }
    /* .color-red { background-color: red; }
    .color-blue { background-color: blue; }
    .color-green { background-color: green; }
    .color-yellow { background-color: yellow; }
    .color-purple { background-color: purple; }
    .color-orange { background-color: orange; }
    .bg-red-light { background-color: rgba(255, 0, 0, 0.1); }
    .bg-blue-light { background-color: rgba(0, 0, 255, 0.1); }
    .bg-green-light { background-color: rgba(0, 255, 0, 0.1); }
    .bg-yellow-light { background-color: rgba(255, 255, 0, 0.1); }
    .bg-purple-light { background-color: rgba(128, 0, 128, 0.1); }
    .bg-orange-light { background-color: rgba(255, 165, 0, 0.1); } */
</style>
{% endblock %}
